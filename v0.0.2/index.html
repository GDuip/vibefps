<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPS Í≤åÏûÑ - Vibe Jam 2025</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'system-ui', sans-serif;
        }
        canvas {
            display: block;
        }
        #gameUI {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 18px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
        }
        .screen h1 {
            font-size: 48px;
            margin-bottom: 20px;
        }
        .screen p {
            font-size: 18px;
            margin-bottom: 30px;
        }
        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
        }
        #mobileControls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: none;
            justify-content: space-between;
        }
        #joystick {
            width: 100px;
            height: 100px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            position: relative;
        }
        #joystickKnob {
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #shootButton {
            width: 70px;
            height: 70px;
            background-color: rgba(255, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .health-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
        }
        .health-fill {
            height: 100%;
            background-color: #ff3333;
            width: 100%;
            transition: width 0.3s;
        }
        #gunEffects {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        #hitMarker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: red;
            font-size: 24px;
            opacity: 0;
            transition: opacity 0.1s;
        }
        .settings-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
        #settingsScreen {
            display: none;
        }
        .settings-grid {
            display: grid;
            grid-template-columns: auto auto;
            gap: 10px;
            margin-bottom: 20px;
        }
        .settings-grid div {
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="startScreen" class="screen">
        <h1>FPS Í≤åÏûÑ</h1>
        <p>WASDÎ°ú Ïù¥Îèô, ÎßàÏö∞Ïä§Î°ú Ï°∞Ï§Ä, ÌÅ¥Î¶≠ÏúºÎ°ú Î∞úÏÇ¨</p>
        <button id="startButton" class="button">Í≤åÏûÑ ÏãúÏûë</button>
    </div>
    
    <div id="settingsScreen" class="screen">
        <h2>ÏÑ§Ï†ï</h2>
        <div class="settings-grid">
            <div>ÏïûÏúºÎ°ú Ïù¥Îèô:</div>
            <div><select id="forwardKey" class="keyBinding">
                <option value="KeyW">W</option>
                <option value="KeyS">S</option>
                <option value="ArrowUp">‚Üë</option>
            </select></div>
            
            <div>Îí§Î°ú Ïù¥Îèô:</div>
            <div><select id="backwardKey" class="keyBinding">
                <option value="KeyS">S</option>
                <option value="KeyW">W</option>
                <option value="ArrowDown">‚Üì</option>
            </select></div>
            
            <div>ÏôºÏ™Ω Ïù¥Îèô:</div>
            <div><select id="leftKey" class="keyBinding">
                <option value="KeyA">A</option>
                <option value="KeyD">D</option>
                <option value="ArrowLeft">‚Üê</option>
            </select></div>
            
            <div>Ïò§Î•∏Ï™Ω Ïù¥Îèô:</div>
            <div><select id="rightKey" class="keyBinding">
                <option value="KeyD">D</option>
                <option value="KeyA">A</option>
                <option value="ArrowRight">‚Üí</option>
            </select></div>
            
            <div>ÏùåÏïÖ Î≥ºÎ•®:</div>
            <div><input type="range" id="musicVolume" min="0" max="1" step="0.1" value="0.5"></div>
            
            <div>Ìö®Í≥ºÏùå Î≥ºÎ•®:</div>
            <div><input type="range" id="sfxVolume" min="0" max="1" step="0.1" value="0.7"></div>
        </div>
        <button id="saveSettings" class="button">Ï†ÄÏû•</button>
        <button id="cancelSettings" class="button">Ï∑®ÏÜå</button>
    </div>
    
    <div id="gameOverScreen" class="screen" style="display: none;">
        <h1>Í≤åÏûÑ Ï¢ÖÎ£å</h1>
        <p>ÏµúÏ¢Ö Ï†êÏàò: <span id="finalScore">0</span></p>
        <button id="restartButton" class="button">Îã§Ïãú ÏãúÏûë</button>
    </div>
    
    <div id="gameUI">
        <div>Ï†êÏàò: <span id="score">0</span></div>
        <div>ÌÉÑÏïΩ: <span id="ammo">30</span> / <span id="maxAmmo">30</span></div>
        <div>ÎÇ®ÏùÄ ÏãúÍ∞Ñ: <span id="timer">60</span>Ï¥à</div>
        <button id="settingsButton" class="settings-btn">‚öôÔ∏è ÏÑ§Ï†ï</button>
    </div>
    
    <div class="health-bar">
        <div class="health-fill" id="healthFill"></div>
    </div>
    
    <img id="crosshair" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iOCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+CiAgPGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iMSIgZmlsbD0id2hpdGUiLz4KICA8bGluZSB4MT0iMTAiIHkxPSIzIiB4Mj0iMTAiIHkyPSI3IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz4KICA8bGluZSB4MT0iMTAiIHkxPSIxMyIgeDI9IjEwIiB5Mj0iMTciIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIvPgogIDxsaW5lIHgxPSIzIiB5MT0iMTAiIHgyPSI3IiB5Mj0iMTAiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIvPgogIDxsaW5lIHgxPSIxMyIgeTE9IjEwIiB4Mj0iMTciIHkyPSIxMCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPg==" alt="Crosshair">
    
    <div id="hitMarker">‚úï</div>
    <div id="gunEffects"></div>
    
    <div id="mobileControls">
        <div id="joystick">
            <div id="joystickKnob"></div>
        </div>
        <div id="shootButton">Î∞úÏÇ¨</div>
    </div>

    <a target="_blank" href="https://jam.pieter.com" style="font-family: 'system-ui', sans-serif; position: fixed; bottom: -1px; right: -1px; padding: 7px; font-size: 14px; font-weight: bold; background: #fff; color: #000; text-decoration: none; z-index: 10; border-top-left-radius: 12px; z-index: 10000; border: 1px solid #fff;">üïπÔ∏è Vibe Jam 2025</a>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>

    <script>
        // Î™®Îìà Ìå®ÌÑ¥ÏúºÎ°ú Í≤åÏûÑ Íµ¨ÏÑ±ÏöîÏÜå Î∂ÑÎ¶¨
        const GameSettings = {
            keyBindings: {
                forward: 'KeyW',
                backward: 'KeyS',
                left: 'KeyA',
                right: 'KeyD',
                jump: 'Space',
                reload: 'KeyR'
            },
            volumes: {
                music: 0.5,
                sfx: 0.7
            },
            saveSettings() {
                const keySelects = document.querySelectorAll('.keyBinding');
                keySelects.forEach(select => {
                    const key = select.id.replace('Key', '').toLowerCase();
                    this.keyBindings[key] = select.value;
                });
                
                this.volumes.music = parseFloat(document.getElementById('musicVolume').value);
                this.volumes.sfx = parseFloat(document.getElementById('sfxVolume').value);
                
                // Apply volume changes
                AudioManager.setVolume('music', this.volumes.music);
                AudioManager.setVolume('sfx', this.volumes.sfx);
            },
            loadSettings() {
                // Load key bindings to UI
                document.getElementById('forwardKey').value = this.keyBindings.forward;
                document.getElementById('backwardKey').value = this.keyBindings.backward;
                document.getElementById('leftKey').value = this.keyBindings.left;
                document.getElementById('rightKey').value = this.keyBindings.right;
                
                // Load volume settings
                document.getElementById('musicVolume').value = this.volumes.music;
                document.getElementById('sfxVolume').value = this.volumes.sfx;
            }
        };

        const AudioManager = {
            sounds: {},
            music: null,
            
            init() {
                // Ìö®Í≥ºÏùå Î°úÎìú
                this.loadSound('shoot', 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAeAAAcLgAHBw4ODhYWFh0dHSUlJS0tLTQ0NDw8PEVFRUFFRUVNTU1VVVVdXV1lZWVtbW11dXV9fX2FhYWNjY2VlZWdnZ2lpaWtra21tbW9vb3FxcXNzc3V1dXd3d3l5eXt7e319fX9/f0FBQUNDQUVFRUdHR0lJSUtLS01NTU9PT1FRUVJSUlRUVFVVVVXV1dZWVlbW1tdXV1fX19hYWFjY2NlZWVnZ2dpbAAAAAAAAAAAAAAAAAAAAAAA//tQZAAA/wAAP8AAAAIAAAP8AAAAQAAAP8AAAAIAAAP8AAAAQ');
                this.loadSound('hit', 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAeAAAcLgAHBw4ODhYWFh0dHSUlJS0tLTQ0NDw8PEVFRUFFRUVNTU1VVVVdXV1lZWVtbW11dXV9fX2FhYWNjY2VlZWdnZ2lpaWtra21tbW9vb3FxcXNzc3V1dXd3d3l5eXt7e319fX9/f0FBQUNDQUVFRUdHR0lJSUtLS01NTU9PT1FRUVJSUlRUVFVVVVXV1dZWVlbW1tdXV1fX19hYWFjY2NlZWVnZ2dpbAAAAAAAAAAAAAAAAAAAAAAA//tQZAAA/wAAP8AAAAIAAAP8AAAAQAAAP8AAAAIAAAP8AAAAQ');
                this.loadSound('reload', 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAeAAAcLgAHBw4ODhYWFh0dHSUlJS0tLTQ0NDw8PEVFRUFFRUVNTU1VVVVdXV1lZWVtbW11dXV9fX2FhYWNjY2VlZWdnZ2lpaWtra21tbW9vb3FxcXNzc3V1dXd3d3l5eXt7e319fX9/f0FBQUNDQUVFRUdHR0lJSUtLS01NTU9PT1FRUVJSUlRUVFVVVVXV1dZWVlbW1tdXV1fX19hYWFjY2NlZWVnZ2dpbAAAAAAAAAAAAAAAAAAAAAAA//tQZAAA/wAAP8AAAAIAAAP8AAAAQAAAP8AAAAIAAAP8AAAAQ');
                this.loadSound('jump', 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAeAAAcLgAHBw4ODhYWFh0dHSUlJS0tLTQ0NDw8PEVFRUFFRUVNTU1VVVVdXV1lZWVtbW11dXV9fX2FhYWNjY2VlZWdnZ2lpaWtra21tbW9vb3FxcXNzc3V1dXd3d3l5eXt7e319fX9/f0FBQUNDQUVFRUdHR0lJSUtLS01NTU9PT1FRUVJSUlRUVFVVVVXV1dZWVlbW1tdXV1fX19hYWFjY2NlZWVnZ2dpbAAAAAAAAAAAAAAAAAAAAAAA//tQZAAA/wAAP8AAAAIAAAP8AAAAQAAAP8AAAAIAAAP8AAAAQ');
                this.loadSound('emptyGun', 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAeAAAcLgAHBw4ODhYWFh0dHSUlJS0tLTQ0NDw8PEVFRUFFRUVNTU1VVVVdXV1lZWVtbW11dXV9fX2FhYWNjY2VlZWdnZ2lpaWtra21tbW9vb3FxcXNzc3V1dXd3d3l5eXt7e319fX9/f0FBQUNDQUVFRUdHR0lJSUtLS01NTU9PT1FRUVJSUlRUVFVVVVXV1dZWVlbW1tdXV1fX19hYWFjY2NlZWVnZ2dpbAAAAAAAAAAAAAAAAAAAAAAA//tQZAAA/wAAP8AAAAIAAAP8AAAAQAAAP8AAAAIAAAP8AAAAQ');
                
                // Î∞∞Í≤Ω ÏùåÏïÖ Î°úÎìú
                this.music = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAeAAAcLgAHBw4ODhYWFh0dHSUlJS0tLTQ0NDw8PEVFRUFFRUVNTU1VVVVdXV1lZWVtbW11dXV9fX2FhYWNjY2VlZWdnZ2lpaWtra21tbW9vb3FxcXNzc3V1dXd3d3l5eXt7e319fX9/f0FBQUNDQUVFRUdHR0lJSUtLS01NTU9PT1FRUVJSUlRUVFVVVVXV1dZWVlbW1tdXV1fX19hYWFjY2NlZWVnZ2dpbAAAAAAAAAAAAAAAAAAAAAAA//tQZAAA/wAAP8AAAAIAAAP8AAAAQAAAP8AAAAIAAAP8AAAAQ');
                this.music.loop = true;
                this.music.volume = GameSettings.volumes.music;
            },
            
            loadSound(name, url) {
                this.sounds[name] = new Audio(url);
                this.sounds[name].volume = GameSettings.volumes.sfx;
            },
            
            play(name) {
                if (this.sounds[name]) {
                    // ÏÇ¨Ïö¥Îìú Ïû¨ÏÉù Ï§ëÎ≥µÏùÑ ÌîºÌïòÍ∏∞ ÏúÑÌï¥ ÌÅ¥Î°† ÏÉùÏÑ±
                    const sound = this.sounds[name].cloneNode();
                    sound.volume = GameSettings.volumes.sfx;
                    sound.play();
                }
            },
            
            playMusic() {
                if (this.music && this.music.paused) {
                    this.music.play();
                }
            },
            
            pauseMusic() {
                if (this.music && !this.music.paused) {
                    this.music.pause();
                }
            },
            
            setVolume(type, volume) {
                if (type === 'music' && this.music) {
                    this.music.volume = volume;
                } else if (type === 'sfx') {
                    for (const sound in this.sounds) {
                        this.sounds[sound].volume = volume;
                    }
                }
            }
        };

        const InputManager = {
            keys: {
                moveForward: false,
                moveBackward: false,
                moveLeft: false,
                moveRight: false
            },
            mouse: {
                x: 0,
                y: 0
            },
            touch: {
                joystickActive: false,
                joystickPosition: { x: 0, y: 0 }
            },
            pointerLocked: false,
            isMobile: false,
            
            init() {
                // Î™®Î∞îÏùº Í∞êÏßÄ
                this.checkMobile();
                
                // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏
                document.addEventListener('keydown', this.onKeyDown.bind(this));
                document.addEventListener('keyup', this.onKeyUp.bind(this));
                
                // ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏
                document.addEventListener('mousemove', this.onMouseMove.bind(this));
                document.addEventListener('click', this.onClick.bind(this));
                
                // Ìè¨Ïù∏ÌÑ∞ ÎùΩ Ïù¥Î≤§Ìä∏
                document.addEventListener('pointerlockchange', this.onPointerLockChange.bind(this));
                
                // Î™®Î∞îÏùº Ïª®Ìä∏Î°§ ÏÑ§Ï†ï
                if (this.isMobile) {
                    this.setupMobileControls();
                }
            },
            
            checkMobile() {
                this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (this.isMobile) {
                    document.getElementById('mobileControls').style.display = 'flex';
                }
            },
            
            setupMobileControls() {
                const joystick = document.getElementById('joystick');
                const joystickKnob = document.getElementById('joystickKnob');
                const shootButton = document.getElementById('shootButton');
                
                // Ï°∞Ïù¥Ïä§Ìã± ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏
                joystick.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.touch.joystickActive = true;
                    this.updateJoystickPosition(e.touches[0]);
                });
                
                document.addEventListener('touchmove', (e) => {
                    if (this.touch.joystickActive) {
                        e.preventDefault();
                        this.updateJoystickPosition(e.touches[0]);
                    }
                });
                
                document.addEventListener('touchend', (e) => {
                    if (this.touch.joystickActive) {
                        e.preventDefault();
                        this.touch.joystickActive = false;
                        this.touch.joystickPosition = { x: 0, y: 0 };
                        joystickKnob.style.transform = 'translate(-50%, -50%)';
                        
                        // ÌÇ§ Î¶¨ÏÖã
                        this.keys.moveForward = false;
                        this.keys.moveBackward = false;
                        this.keys.moveLeft = false;
                        this.keys.moveRight = false;
                    }
                });
                
                // Î∞úÏÇ¨ Î≤ÑÌäº
                shootButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    Game.shoot();
                });
            },
            
            updateJoystickPosition(touch) {
                const joystick = document.getElementById('joystick');
                const joystickKnob = document.getElementById('joystickKnob');
                
                const joystickRect = joystick.getBoundingClientRect();
                const centerX = joystickRect.left + joystickRect.width / 2;
                const centerY = joystickRect.top + joystickRect.height / 2;
                
                let deltaX = touch.clientX - centerX;
                let deltaY = touch.clientY - centerY;
                
                // Ï°∞Ïù¥Ïä§Ìã± Î≤îÏúÑ Ï†úÌïú
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const maxDistance = joystickRect.width / 2 - 20;
                
                if (distance > maxDistance) {
                    deltaX = (deltaX / distance) * maxDistance;
                    deltaY = (deltaY / distance) * maxDistance;
                }
                
                // Ï°∞Ïù¥Ïä§Ìã± ÎÖ∏Î∏å ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
                joystickKnob.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
                
                // Î∞©Ìñ• Í≥ÑÏÇ∞
                this.touch.joystickPosition = {
                    x: deltaX / maxDistance,
                    y: deltaY / maxDistance
                };
                
                // ÌÇ§ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                this.keys.moveForward = deltaY < -0.3;
                this.keys.moveBackward = deltaY > 0.3;
                this.keys.moveLeft = deltaX < -0.3;
                this.keys.moveRight = deltaX > 0.3;
            },
            
            onKeyDown(event) {
                if (!Game.gameStarted) return;
                
                const key = event.code;
                
                if (key === GameSettings.keyBindings.forward) {
                    this.keys.moveForward = true;
                } else if (key === GameSettings.keyBindings.backward) {
                    this.keys.moveBackward = true;
                } else if (key === GameSettings.keyBindings.left) {
                    this.keys.moveLeft = true;
                } else if (key === GameSettings.keyBindings.right) {
                    this.keys.moveRight = true;
                } else if (key === GameSettings.keyBindings.jump) {
                    if (Physics.playerBody.position.y <= 1.7) {
                        Physics.playerBody.velocity.y = 7;
                        AudioManager.play('jump');
                    }
                } else if (key === GameSettings.keyBindings.reload) {
                    Game.reload();
                }
            },
            
            onKeyUp(event) {
                if (!Game.gameStarted) return;
                
                const key = event.code;
                
                if (key === GameSettings.keyBindings.forward) {
                    this.keys.moveForward = false;
                } else if (key === GameSettings.keyBindings.backward) {
                    this.keys.moveBackward = false;
                } else if (key === GameSettings.keyBindings.left) {
                    this.keys.moveLeft = false;
                } else if (key === GameSettings.keyBindings.right) {
                    this.keys.moveRight = false;
                }
            },
            
            onMouseMove(event) {
                if (!Game.gameStarted || !this.pointerLocked) return;
                
                const movementX = event.movementX || 0;
                const movementY = event.movementY || 0;
                
                Graphics.camera.rotation.y -= movementX * 0.002;
                Graphics.camera.rotation.x -= movementY * 0.002;
                
                // ÏÉÅÌïò ÌöåÏ†Ñ Ï†úÌïú
                Graphics.camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, Graphics.camera.rotation.x));
            },
            
            onClick() {
                if (!Game.gameStarted) return;
                
                if (!this.pointerLocked) {
                    Graphics.renderer.domElement.requestPointerLock();
                } else {
                    Game.shoot();
                }
            },
            
            onPointerLockChange() {
                this.pointerLocked = document.pointerLockElement === Graphics.renderer.domElement;
            }
        };

        const Graphics = {
            scene: null,
            camera: null,
            renderer: null,
            clock: null,
            
            init() {
                // Ïî¨ ÏÑ§Ï†ï
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x87CEEB);
                
                // Ïπ¥Î©îÎùº ÏÑ§Ï†ï
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.y = 1.6; // ÌîåÎ†àÏù¥Ïñ¥ ÎààÎÜíÏù¥
                
                // Î†åÎçîÎü¨ ÏÑ§Ï†ï
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                document.body.appendChild(this.renderer.domElement);
                
                // ÌÅ¥Î°ù ÏÉùÏÑ±
                this.clock = new THREE.Clock();
                
                // ÏúàÎèÑÏö∞ Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§Îü¨
                window.addEventListener('resize', this.onWindowResize.bind(this));
            },
            
            onWindowResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            },
            
            setupLights() {
                const ambientLight = new THREE.AmbientLight(0x404040, 2);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(10, 20, 10);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                this.scene.add(directionalLight);
            },
            
            createGunFlash() {
                const flash = document.createElement('div');
                flash.style.position = 'absolute';
                flash.style.bottom = '50%';
                flash.style.right = '50%';
                flash.style.width = '50px';
                flash.style.height = '50px';
                flash.style.borderRadius = '50%';
                flash.style.backgroundColor = 'rgba(255, 200, 50, 0.8)';
                flash.style.boxShadow = '0 0 20px 10px rgba(255, 200, 50, 0.5)';
                flash.style.transform = 'translate(50%, 50%)';
                flash.style.opacity = '0.9';
                
                document.getElementById('gunEffects').appendChild(flash);
                
                setTimeout(() => {
                    flash.remove();
                }, 100);
            },
            
            showHitMarker() {
                const hitMarker = document.getElementById('hitMarker');
                hitMarker.style.opacity = '1';
                
                setTimeout(() => {
                    hitMarker.style.opacity = '0';
                }, 200);
            }
        };

        const Physics = {
            world: null,
            playerBody: null,
            
            init() {
                this.world = new CANNON.World();
                this.world.gravity.set(0, -9.82, 0);
                this.world.broadphase = new CANNON.NaiveBroadphase();
                this.world.solver.iterations = 10;
                
                // ÌîåÎ†àÏù¥Ïñ¥ Î¨ºÎ¶¨ Î™∏Ï≤¥ ÏÉùÏÑ±
                const playerShape = new CANNON.Sphere(1);
                this.playerBody = new CANNON.Body({
                    mass: 5,
                    position: new CANNON.Vec3(0, 1.6, 0),
                    shape: playerShape,
                    material: new CANNON.Material()
                });
                this.world.addBody(this.playerBody);
                
                // Î∞îÎã• ÏÉùÏÑ±
                const groundShape = new CANNON.Plane();
                const groundBody = new CANNON.Body({
                    mass: 0,
                    shape: groundShape,
                    material: new CANNON.Material()
                });
                groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
                this.world.addBody(groundBody);
            },
            
            update(delta) {
                this.world.step(1/60, delta, 3);
            }
        };

        const Environment = {
            obstacles: [],
            
            init() {
                this.createFloor();
                this.createWalls();
                this.createObstacles(15);
            },
            
            createFloor() {
                // Î∞îÎã• ÏÉùÏÑ±
                const floorGeometry = new THREE.PlaneGeometry(100, 100);
                const floorMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x555555,
                    roughness: 0.8,
                    metalness: 0.2
                });
                const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                floor.rotation.x = -Math.PI / 2;
                floor.receiveShadow = true;
                Graphics.scene.add(floor);
            },
            
            createWalls() {
                const wallMaterial = new THREE.MeshStandardMaterial({
                    color: 0x888888,
                    roughness: 0.7,
                    metalness: 0.1
                });
                
                // Î∂ÅÏ™Ω Î≤Ω
                const northWall = new THREE.Mesh(
                    new THREE.BoxGeometry(100, 10, 1),
                    wallMaterial
                );
                northWall.position.set(0, 5, -50);
                northWall.receiveShadow = true;
                northWall.castShadow = true;
                Graphics.scene.add(northWall);
                
                // ÎÇ®Ï™Ω Î≤Ω
                const southWall = new THREE.Mesh(
                    new THREE.BoxGeometry(100, 10, 1),
                    wallMaterial
                );
                southWall.position.set(0, 5, 50);
                southWall.receiveShadow = true;
                southWall.castShadow = true;
                Graphics.scene.add(southWall);
                
                // ÎèôÏ™Ω Î≤Ω
                const eastWall = new THREE.Mesh(
                    new THREE.BoxGeometry(1, 10, 100),
                    wallMaterial
                );
                eastWall.position.set(50, 5, 0);
                eastWall.receiveShadow = true;
                eastWall.castShadow = true;
                Graphics.scene.add(eastWall);
                
                // ÏÑúÏ™Ω Î≤Ω
                const westWall = new THREE.Mesh(
                    new THREE.BoxGeometry(1, 10, 100),
                    wallMaterial
                );
                westWall.position.set(-50, 5, 0);
                westWall.receiveShadow = true;
                westWall.castShadow = true;
                Graphics.scene.add(westWall);
                
                // Î¨ºÎ¶¨ Î≤Ω Ï∂îÍ∞Ä
                this.addWallBody(new CANNON.Vec3(0, 5, -50), new CANNON.Vec3(50, 5, 0.5));
                this.addWallBody(new CANNON.Vec3(0, 5, 50), new CANNON.Vec3(50, 5, 0.5));
                this.addWallBody(new CANNON.Vec3(50, 5, 0), new CANNON.Vec3(0.5, 5, 50));
                this.addWallBody(new CANNON.Vec3(-50, 5, 0), new CANNON.Vec3(0.5, 5, 50));
            },
            
            addWallBody(position, halfExtents) {
                const wallShape = new CANNON.Box(halfExtents);
                const wallBody = new CANNON.Body({
                    mass: 0,
                    position: position,
                    shape: wallShape
                });
                Physics.world.addBody(wallBody);
            },
            
            createObstacles(count) {
                for (let i = 0; i < count; i++) {
                    const obstacleGeometry = new THREE.BoxGeometry(
                        Math.random() * 3 + 1,
                        Math.random() * 3 + 1,
                        Math.random() * 3 + 1
                    );
                    const obstacleMaterial = new THREE.MeshStandardMaterial({
                        color: new THREE.Color(Math.random() * 0.5 + 0.5, Math.random() * 0.5 + 0.5, Math.random() * 0.5 + 0.5),
                        roughness: 0.7,
                        metalness: 0.2
                    });
                    const obstacle = new THREE.Mesh(obstacleGeometry, obstacleMaterial);
                    
                    obstacle.position.x = Math.random() * 80 - 40;
                    obstacle.position.y = obstacleGeometry.parameters.height / 2;
                    obstacle.position.z = Math.random() * 80 - 40;
                    
                    obstacle.castShadow = true;
                    obstacle.receiveShadow = true;
                    Graphics.scene.add(obstacle);
                    
                    // Ïû•Ïï†Î¨º Î¨ºÎ¶¨ Î™∏Ï≤¥ Ï∂îÍ∞Ä
                    const obstacleShape = new CANNON.Box(new CANNON.Vec3(
                        obstacleGeometry.parameters.width / 2,
                        obstacleGeometry.parameters.height / 2,
                        obstacleGeometry.parameters.depth / 2
                    ));
                    const obstacleBody = new CANNON.Body({
                        mass: 0,
                        position: new CANNON.Vec3(obstacle.position.x, obstacle.position.y, obstacle.position.z),
                        shape: obstacleShape
                    });
                    Physics.world.addBody(obstacleBody);
                    
                    this.obstacles.push({
                        mesh: obstacle,
                        body: obstacleBody
                    });
                }
            }
        };

        const TargetManager = {
            targets: [],
            
            init() {
                this.createTargets(20);
            },
            
            createTargets(count) {
                const targetGeometry = new THREE.SphereGeometry(0.5, 16, 16);
                const targetMaterial = new THREE.MeshStandardMaterial({
                    color: 0xff0000,
                    roughness: 0.5,
                    metalness: 0.5,
                    emissive: 0x330000
                });
                
                for (let i = 0; i < count; i++) {
                    const target = new THREE.Mesh(targetGeometry, targetMaterial);
                    
                    // ÎûúÎç§ ÏúÑÏπò ÏÑ§Ï†ï
                    target.position.x = Math.random() * 80 - 40;
                    target.position.y = Math.random() * 5 + 1;
                    target.position.z = Math.random() * 80 - 40;
                    
                    target.castShadow = true;
                    target.receiveShadow = true;
                    Graphics.scene.add(target);
                    
                    this.targets.push({
                        mesh: target,
                        active: true,
                        respawnTime: 0
                    });
                }
            },
            
            update() {
                // ÌÉÄÍ≤ü Î¶¨Ïä§Ìè∞ Ï≤¥ÌÅ¨
                for (let i = 0; i < this.targets.length; i++) {
                    const target = this.targets[i];
                    if (!target.active && Game.timeLeft <= target.respawnTime) {
                        target.active = true;
                        target.mesh.visible = true;
                        
                        // ÏÉà ÏúÑÏπò ÏÑ§Ï†ï
                        target.mesh.position.x = Math.random() * 80 - 40;
                        target.mesh.position.y = Math.random() * 5 + 1;
                        target.mesh.position.z = Math.random() * 80 - 40;
                    }
                }
            },
            
            checkHit(raycaster) {
                for (let i = 0; i < this.targets.length; i++) {
                    const target = this.targets[i];
                    if (!target.active) continue;
                    
                    const intersects = raycaster.intersectObject(target.mesh);
                    
                    if (intersects.length > 0) {
                        // ÌÉÄÍ≤ü ÌûàÌä∏
                        target.active = false;
                        target.mesh.visible = false;
                        target.respawnTime = Game.timeLeft - 5; // 5Ï¥à ÌõÑ Î¶¨Ïä§Ìè∞
                        
                        // Ï†êÏàò Ï¶ùÍ∞Ä
                        Game.addScore(10);
                        
                        // ÌûàÌä∏ ÎßàÏª§ ÌëúÏãú
                        Graphics.showHitMarker();
                        
                        // Ìö®Í≥ºÏùå
                        AudioManager.play('hit');
                        
                        return true;
                    }
                }
                return false;
            }
        };

        const Game = {
            gameStarted: false,
            score: 0,
            ammo: 30,
            maxAmmo: 30,
            timeLeft: 60,
            health: 100,
            playerVelocity: new THREE.Vector3(),
            playerDirection: new THREE.Vector3(),
            timerInterval: null,
  
            // Î∂ÄÎ™® Ï∞ΩÍ≥º ÌÜµÏã†ÌïòÎäî Ìï®Ïàò
            sendGameState(state) {
              if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                  type: 'gameStateUpdate',
                  state: state // 'menu', 'playing', 'gameOver' Ï§ë ÌïòÎÇò
                }, '*');
              }
            },
            
            init() {
                // Í≤åÏûÑ ÏóîÏßÑ Ï¥àÍ∏∞Ìôî
                Graphics.init();
                Physics.init();
                Graphics.setupLights();
                Environment.init();
                TargetManager.init();
                AudioManager.init();
                InputManager.init();
                
                // UI Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
                this.setupUIEvents();
                
                // ÏÑ§Ï†ï Î°úÎìú
                GameSettings.loadSettings();
    
                // Î∂ÄÎ™® Ï∞ΩÏóê Î©îÎâ¥ ÏÉÅÌÉú ÏïåÎ¶º
                this.sendGameState('menu');
            },
            
            setupUIEvents() {
                // ÏãúÏûë ÌôîÎ©¥
                document.getElementById('startButton').addEventListener('click', () => {
                    document.getElementById('startScreen').style.display = 'none';
                    this.startGame();
                });
                
                // Í≤åÏûÑ Ïò§Î≤Ñ ÌôîÎ©¥
                document.getElementById('restartButton').addEventListener('click', () => {
                    document.getElementById('gameOverScreen').style.display = 'none';
                    location.reload(); // Í∞ÑÎã®ÌïòÍ≤å Î¶¨Î°úÎìúÎ°ú Ïû¨ÏãúÏûë
                });
                
                // ÏÑ§Ï†ï ÌôîÎ©¥
                document.getElementById('settingsButton').addEventListener('click', () => {
                    this.showSettings();
                });
                
                document.getElementById('saveSettings').addEventListener('click', () => {
                    GameSettings.saveSettings();
                    document.getElementById('settingsScreen').style.display = 'none';
                    
                    if (this.gameStarted) {
                        Graphics.renderer.domElement.requestPointerLock();
                    }
                });
                
                document.getElementById('cancelSettings').addEventListener('click', () => {
                    document.getElementById('settingsScreen').style.display = 'none';
                    GameSettings.loadSettings(); // Ïù¥Ï†Ñ ÏÑ§Ï†ï Î≥µÏõê
                    
                    if (this.gameStarted) {
                        Graphics.renderer.domElement.requestPointerLock();
                    }
                });
            },
            
            startGame() {
                this.gameStarted = true;
                this.sendGameState('playing'); // Í≤åÏûÑ ÏãúÏûë ÏÉÅÌÉú ÏïåÎ¶º
                
                // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                this.score = 0;
                this.ammo = this.maxAmmo;
                this.timeLeft = 60;
                this.health = 100;
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('score').textContent = this.score;
                document.getElementById('ammo').textContent = this.ammo;
                document.getElementById('maxAmmo').textContent = this.maxAmmo;
                document.getElementById('timer').textContent = this.timeLeft;
                document.getElementById('healthFill').style.width = '100%';
                
                // ÌÉÄÏù¥Î®∏ ÏãúÏûë
                this.startTimer();
                
                // Î∞∞Í≤Ω ÏùåÏïÖ ÏãúÏûë
                AudioManager.playMusic();
                
                // Ïï†ÎãàÎ©îÏù¥ÏÖò Î£®ÌîÑ ÏãúÏûë
                this.animate();
                
                // Ìè¨Ïù∏ÌÑ∞ ÎùΩ ÏöîÏ≤≠
                Graphics.renderer.domElement.requestPointerLock();
            },
            
            startTimer() {
                this.timerInterval = setInterval(() => {
                    this.timeLeft--;
                    document.getElementById('timer').textContent = this.timeLeft;
                    
                    if (this.timeLeft <= 0) {
                        clearInterval(this.timerInterval);
                        this.gameOver();
                    }
                }, 1000);
            },
            
            gameOver() {
                this.gameStarted = false;
                AudioManager.pauseMusic();
                clearInterval(this.timerInterval);
                
                // Ìè¨Ïù∏ÌÑ∞ ÎùΩ Ìï¥Ï†ú
                if (document.pointerLockElement) {
                    document.exitPointerLock();
                }
                
                // Í≤åÏûÑ Ïò§Î≤Ñ ÌôîÎ©¥ ÌëúÏãú
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('gameOverScreen').style.display = 'flex';

                // Î∂ÄÎ™® Ï∞ΩÏóê Í≤åÏûÑ Ïò§Î≤Ñ ÏÉÅÌÉú ÏïåÎ¶º
                this.sendGameState('gameOver');
            },
            
            shoot() {
                if (!this.gameStarted || this.ammo <= 0) {
                    if (this.ammo <= 0) {
                        AudioManager.play('emptyGun');
                    }
                    return;
                }
                
                this.ammo--;
                document.getElementById('ammo').textContent = this.ammo;
                
                // Ï¥ùÍµ¨ ÌôîÏóº Ìö®Í≥º
                Graphics.createGunFlash();
                
                // Î∞úÏÇ¨ Ìö®Í≥ºÏùå
                AudioManager.play('shoot');
                
                // Î†àÏù¥Ï∫êÏä§ÌåÖÏúºÎ°ú ÌÉÄÍ≤ü Í∞êÏßÄ
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(new THREE.Vector2(), Graphics.camera);
                
                // ÌÉÄÍ≤ü ÌûàÌä∏ Ï≤¥ÌÅ¨
                TargetManager.checkHit(raycaster);
            },
            
            reload() {
                if (this.ammo < this.maxAmmo) {
                    AudioManager.play('reload');
                    this.ammo = this.maxAmmo;
                    document.getElementById('ammo').textContent = this.ammo;
                }
            },
            
            addScore(points) {
                this.score += points;
                document.getElementById('score').textContent = this.score;
            },
            
            takeDamage(amount) {
                this.health -= amount;
                this.health = Math.max(0, this.health);
                document.getElementById('healthFill').style.width = `${this.health}%`;
                
                if (this.health <= 0) {
                    this.gameOver();
                }
            },
            
            updatePlayer(delta) {
                if (!this.gameStarted) return;
                
                // Ïù¥Îèô Î∞©Ìñ• Í≥ÑÏÇ∞
                this.playerDirection.z = Number(InputManager.keys.moveForward) - Number(InputManager.keys.moveBackward);
                this.playerDirection.x = Number(InputManager.keys.moveRight) - Number(InputManager.keys.moveLeft);
                this.playerDirection.normalize();
                
                // ÌîåÎ†àÏù¥Ïñ¥ Î∞©Ìñ•Ïóê Ïπ¥Î©îÎùº ÌöåÏ†Ñ Ï†ÅÏö©
                this.playerDirection.applyEuler(new THREE.Euler(0, Graphics.camera.rotation.y, 0));
                
                // ÏÜçÎèÑ Ï†ÅÏö©
                const speed = 5;
                this.playerVelocity.x = this.playerDirection.x * speed * delta;
                this.playerVelocity.z = this.playerDirection.z * speed * delta;
                
                // Î¨ºÎ¶¨ Î™∏Ï≤¥Ïóê ÏÜçÎèÑ Ï†ÅÏö©
                Physics.playerBody.velocity.x = this.playerVelocity.x * 20;
                Physics.playerBody.velocity.z = this.playerVelocity.z * 20;
                
                // Î¨ºÎ¶¨ ÏúÑÏπòÎ•º Ïπ¥Î©îÎùºÏóê Ï†ÅÏö©
                Graphics.camera.position.x = Physics.playerBody.position.x;
                Graphics.camera.position.y = Physics.playerBody.position.y;
                Graphics.camera.position.z = Physics.playerBody.position.z;
            },
            
            showSettings() {
                // Ìè¨Ïù∏ÌÑ∞ ÎùΩ Ìï¥Ï†ú
                if (document.pointerLockElement) {
                    document.exitPointerLock();
                }
                
                // ÏÑ§Ï†ï Î°úÎìú
                GameSettings.loadSettings();
                
                // ÏÑ§Ï†ï ÌôîÎ©¥ ÌëúÏãú
                document.getElementById('settingsScreen').style.display = 'flex';
            },
            
            animate() {
                if (!this.gameStarted) return;
                
                requestAnimationFrame(this.animate.bind(this));
                
                const delta = Graphics.clock.getDelta();
                
                // Î¨ºÎ¶¨ ÏóÖÎç∞Ïù¥Ìä∏
                Physics.update(delta);
                
                // ÌîåÎ†àÏù¥Ïñ¥ ÏóÖÎç∞Ïù¥Ìä∏
                this.updatePlayer(delta);
                
                // ÌÉÄÍ≤ü ÏóÖÎç∞Ïù¥Ìä∏
                TargetManager.update();
                
                // Î†åÎçîÎßÅ
                Graphics.renderer.render(Graphics.scene, Graphics.camera);
            }
        };

        window.addEventListener('message', (event) => {
          const message = event.data;
          if (message && message.type === 'checkGameState') {
            // ÌòÑÏû¨ Í≤åÏûÑ ÏÉÅÌÉú ÌôïÏù∏ Î∞è Ï†ÑÏÜ°
            if (Game.gameStarted) {
              Game.sendGameState('playing');
            } else {
              if (document.getElementById('gameOverScreen').style.display === 'flex') {
                Game.sendGameState('gameOver');
              } else {
                Game.sendGameState('menu');
              }
            }
          }
        });

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í≤åÏûÑ Ï¥àÍ∏∞Ìôî
        window.addEventListener('load', () => {
            Game.init();
        });
    </script>
</body>
</html>
