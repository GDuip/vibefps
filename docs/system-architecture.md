# FPS 게임 프로젝트 아키텍처 명세서 (Vibe Jam 2025)

## 1. 프로젝트 개요

본 프로젝트는 "Vibe Jam 2025" 대회를 위한 웹 기반 FPS(First Person Shooter) 게임으로, ThreeJS와 CannonJS를 활용한 3D 환경에서 총으로 타겟을 맞추는 게임입니다. 주요 요구사항은 다음과 같습니다:

- 코드의 80% 이상이 AI에 의해 작성되어야 함
- 웹 브라우저에서 로딩 화면 없이 즉시 플레이 가능해야 함
- 사용자 로그인이나 가입 없이 무료로 플레이 가능해야 함
- ThreeJS를 활용한 3D 그래픽 구현
- 모바일 및 데스크톱 환경 모두 지원

## 2. 시스템 아키텍처

### 2.1 전체 시스템 구성

프로젝트는 모듈식 아키텍처를 채택하여 다음과 같은 주요 시스템으로 구성됩니다:

```
+----------------------------------+
|          EventSystem             |
|    (Module Communication Bus)    |
+----------------------------------+
              |
              v
+----------------------------------+
|            Game Core             |
|        (Game.js, main)           |
+----------------------------------+
         |         |        |
 +---------------+ | +----------------+
 |    Rendering  | | |  Physics &     |
 |   (Graphics)  | | |  Environment   |
 +---------------+ | +----------------+
         |         |        |
+----------------+ | +----------------+
|    Gameplay    | | |    Input &     |
|   (Targets)    | | |   Controls     |
+----------------+ | +----------------+
         |         |        |
 +---------------+ | +----------------+
 |   Feedback    | | |   Settings &   |
 | (Audio, FX)   | | |  Localization  |
 +---------------+ | +----------------+
         |         |
 +---------------+ |
 | SpatialAudio  | |
 |   System      | |
 +---------------+ |
```

### 2.2 버전 관리 시스템

프로젝트는 여러 버전(v0.0.1부터 v0.1.7까지)으로 구성되며, 루트 `index.html` 파일이 버전 선택 인터페이스를 제공합니다:

- 각 버전은 독립적인 폴더 구조를 가짐
- iframe을 통해 선택된 버전의 게임이 로드됨
- 버전 간 통신은 window.postMessage API를 사용
- 게임 상태(menu, playing, gameOver)에 따라 버전 선택기 UI 표시/숨김 처리

## 3. 핵심 모듈 구성

### 3.1 EventSystem (이벤트 시스템)

```
+------------------+
|   EventSystem.js |
+------------------+
| - 이벤트 등록     |
| - 이벤트 발행     |
| - 모듈 간 통신    |
| - 느슨한 결합 유지|
+------------------+
```

- **주요 기능**:
  - 모듈 간 통신을 위한 발행-구독(Pub/Sub) 패턴 구현
  - 이벤트 리스너 등록, 해제, 발행 메서드 제공
  - 일회성 이벤트 구독 메서드 제공
  - 디버깅 지원 (이벤트 수, 활성 구독 등 추적)
  - 중앙화된 메시지 시스템으로 모듈 간 직접 참조 최소화

### 3.2 핵심 게임 엔진 (Game.js)

```
+------------------+
|      Game.js     |
+------------------+
| - 게임 상태 관리  |
| - 게임 루프      |
| - 물리 엔진 통합  |
| - 점수/탄약/시간  |
| - 발사 메커니즘   |
| - 설정 화면 제어  |
| - 이벤트 처리     |
+------------------+
```

- **주요 기능**:
  - 게임 초기화 및 애니메이션 루프 관리
  - 플레이어 상태(점수, 탄약, 시간, 체력) 관리
  - 타이머 및 게임 종료 조건 처리
  - `targetHit` 이벤트를 구독하여 점수 업데이트 처리
  - `gameStateChanged` 이벤트 발행으로 UI 업데이트
  - 다른 모듈과의 통합 및 조정
  - 부모 창과의 통신(iframe 사용 시)

### 3.3 렌더링 시스템 (Graphics.js)

```
+------------------+
|    Graphics.js   |
+------------------+
| - ThreeJS 초기화  |
| - 씬 렌더링      |
| - 카메라 제어     |
| - 광원 설정      |
| - 특수 효과      |
+------------------+
```

- **주요 기능**:
  - ThreeJS 씬, 카메라, 렌더러 초기화 및 관리
  - 조명 및 그림자 설정
  - 시각적 피드백(총구 화염, 히트 마커, 점수 텍스트)
  - 화면 크기 변경 대응(반응형)
  - 특수 효과(타겟 타격 시 스크린 효과)

### 3.4 물리 시스템 (Physics.js)

```
+------------------+
|    Physics.js    |
+------------------+
| - CannonJS 초기화 |
| - 물리 법칙 적용  |
| - 충돌 감지      |
| - 중력 계산      |
+------------------+
```

- **주요 기능**:
  - CannonJS 물리 세계 초기화
  - 플레이어 물리 몸체 생성 및 제어
  - 중력 및 충돌 시뮬레이션
  - 물리 단계(step) 업데이트

### 3.5 환경 시스템 (Environment.js)

```
+------------------+
|  Environment.js  |
+------------------+
| - 맵 구성 요소    |
| - 바닥, 벽 생성   |
| - 장애물 배치     |
| - 물리 충돌체 연결 |
+------------------+
```

- **주요 기능**:
  - 게임 환경 요소 생성(바닥, 벽, 장애물)
  - 3D 메시와 물리 충돌체 연결
  - 장애물 랜덤 배치
  - 맵 경계 설정

### 3.6 타겟 관리 시스템 (TargetManager.js)

```
+------------------+
| TargetManager.js |
+------------------+
| - 타겟 생성/관리  |
| - 타입별 타겟     |
| - 콤보 시스템     |
| - 히트 감지       |
| - 관통 샷 처리    |
| - 이벤트 발생     |
+------------------+
```

- **주요 기능**:
  - 여러 타입의 타겟 생성 및 관리(표준, 보너스, 페널티)
  - 타겟 움직임 패턴 및 리스폰 로직
  - 레이캐스팅을 통한 히트 감지
  - `targetHit` 이벤트 발생으로 점수 시스템과 느슨한 결합 유지
  - 콤보 시스템 및 배율 계산
  - 관통 샷 처리 및 특수 효과 (한 발로 여러 타겟 타격)

### 3.7 입력 시스템 (InputManager.js)

```
+------------------+
|  InputManager.js |
+------------------+
| - 키보드 입력 처리 |
| - 마우스 입력 처리 |
| - 터치 입력 처리   |
| - 플랫폼 감지      |
| - 포인터 락 관리   |
| - 이벤트 수신     |
+------------------+
```

- **주요 기능**:
  - 키보드, 마우스, 터치 입력 처리
  - 모바일/데스크톱 환경 감지 및 대응
  - 카메라 회전(시점 변경) 처리
  - 포인터 락 상태 관리
  - 조이스틱 및 모바일 컨트롤 구현
  - `gameStateChanged` 이벤트 수신하여 버튼 상태 업데이트

### 3.8 오디오 시스템 (AudioManager.js)

```
+------------------+
|  AudioManager.js |
+------------------+
| - 효과음 생성/재생 |
| - 배경음악 관리    |
| - 볼륨 조절       |
| - 절차적 사운드 생성|
| - 공간 오디오 효과 |
+------------------+
```

- **주요 기능**:
  - Web Audio API를 활용한 절차적 사운드 생성
  - 다양한 총소리 유형(표준, 강력, 소음기) 동적 생성
  - 거리 및 방향에 따른 사운드 특성 조정
  - 게임 이벤트(발사, 타격, 재장전, 점프 등)별 사운드 생성
  - 공간적 반향 효과 처리(벽 반사음)
  - 볼륨 설정 관리

### 3.9 공간 오디오 시스템 (SpatialAudioSystem.js)

```
+------------------+
|SpatialAudioSystem|
+------------------+
| - 공간 분석      |
| - 방향성 반향 계산|
| - 3D 오디오 처리 |
| - 스테레오 패닝  |
| - 품질 설정 관리 |
+------------------+
```

- **주요 기능**:
  - 레이캐스팅을 통한 플레이어 주변 환경 분석
  - 각 벽까지의 거리와 방향에 따른 반향 효과 계산
  - 방향성 스테레오 패닝으로 사실적인 방향감 부여
  - 플레이어 방향 기반 좌우 채널 분배
  - 품질 설정(저/중/고)에 따른 계산 최적화
  - 성능 최적화를 위한 공간 분석 결과 캐싱

### 3.10 게임 설정 시스템 (GameSettings.js)

```
+------------------+
| GameSettings.js  |
+------------------+
| - 키 바인딩 설정  |
| - 볼륨 설정      |
| - 오디오 품질 설정|
| - 설정 저장/로드  |
| - 오디오 테스트 UI|
+------------------+
```

- **주요 기능**:
  - 게임 컨트롤 키 매핑 설정
  - 오디오 볼륨 설정
  - 공간 오디오 품질 설정 관리
  - 오디오 시스템 테스트 UI 제공
  - 설정 저장 및 로드
  - 설정 UI와의 연동

### 3.11 파티클 시스템 (ParticleSystem.js)

```
+------------------+
| ParticleSystem.js|
+------------------+
| - 파티클 생성     |
| - 파티클 애니메이션|
| - 타겟별 효과     |
| - 리소스 관리     |
+------------------+
```

- **주요 기능**:
  - 타겟 파괴 시 파티클 효과 생성
  - 파티클 애니메이션 및 수명 관리
  - 타겟 유형별 차별화된 효과
  - 파티클 리소스 최적화 및 정리

### 3.12 다국어 지원 시스템 (Localization.js)

```
+------------------+
| Localization.js  |
+------------------+
| - 언어 감지/설정  |
| - 텍스트 리소스   |
| - UI 업데이트     |
| - 설정 저장      |
+------------------+
```

- **주요 기능**:
  - 브라우저 언어 감지
  - 다국어 리소스 관리(한국어, 영어)
  - UI 텍스트 동적 업데이트
  - 언어 설정 저장

### 3.13 특수 기능 모듈 (GitHubTarget.js)

```
+------------------+
| GitHubTarget.js  |
+------------------+
| - 특수 타겟 생성  |
| - 히트 감지      |
| - 특수 효과      |
| - 링크 표시      |
+------------------+
```

- **주요 기능**:
  - GitHub 로고 모양의 특수 타겟 생성
  - 히트 감지 및 처리
  - 파티클 및 UI 효과
  - GitHub 저장소 링크 표시 팝업

## 4. 데이터 흐름 및 상호작용

### 4.1 이벤트 기반 모듈 통신

```
                    +-------------------------------+
                    |         EventSystem           |
                    |  (Central Communication Bus)  |
                    +-------------------------------+
                       ^      ^       ^       ^
                       |      |       |       |
          +------------+      |       |       +------------+
          |                   |       |                    |
+---------v--------+  +-------v-----+ | +----------------+ | 
|     Game.js      |  | InputManager| | |  TargetManager | |
| - Subscribes to: |  |             | | |  - Emits:      | |
| 'targetHit'      |  | - Subscribes:| | |  'targetHit'   | |
| - Emits:         |  | 'gameState  | | |                | |
| 'gameStateChanged'|  |  Changed'   | | |                | |
+------------------+  +-------------+ | +----------------+ |
                                      |                    |
                         +------------v----+  +------------v--+
                         |   Graphics.js   |  | AudioManager  |
                         +----------------+  +---------------+
```

- 핵심 이벤트 흐름:
  - `TargetManager`는 타겟 명중 시 `targetHit` 이벤트 발생
  - `Game`은 `targetHit` 이벤트를 구독하여 점수 추가 및 관련 로직 실행
  - `Game`은 게임 상태 변경 시 `gameStateChanged` 이벤트 발생
  - `InputManager`는 `gameStateChanged` 이벤트를 구독하여 설정 버튼 상태 관리
  - 직접적인 모듈 간 참조는 최소화하고 이벤트 시스템을 통해 통신

### 4.2 이벤트 흐름

1. **사용자 입력 처리**:
   ```
   사용자 입력 → InputManager → Game → Physics → Graphics
   ```

2. **발사 및 타겟 히트**:
   ```
   클릭 → InputManager → Game → 레이캐스트 → TargetManager 
   → EventSystem.emit('targetHit') → Game.addScore
   → 파티클/점수/사운드 → Graphics/AudioManager/ParticleSystem
   ```

3. **게임 상태 변경**:
   ```
   상태 변경 → Game → EventSystem.emit('gameStateChanged') 
   → InputManager(버튼 상태 변경) → UI 업데이트 → 부모 iframe 통신
   ```

4. **오디오 처리 흐름**:
   ```
   총 발사 → Game → AudioManager.play → SpatialAudioSystem.createGunSoundWithReverb
   → 방향성 반향 분석 → 품질 설정 적용 → 스테레오 패닝 반향 생성
   ```

## 5. 주요 기능 구현

### 5.1 타겟 시스템

- **표준 타겟**: 빨간색, 10점, 느린 움직임
- **보너스 타겟**: 금색, 25점, 빠른 움직임, 특수 효과
- **페널티 타겟**: 녹색, -15점, 중간 속도, 콤보 리셋

### 5.2 콤보 시스템

- **콤보 카운트**: 연속 타격 시 증가, 페널티 타겟 또는 시간 초과 시 리셋
- **배율 시스템**: 3타 이상(1.5배), 5타 이상(2.0배), 10타 이상(3.0배)
- **시각적 피드백**: 화면 중앙에 콤보 카운터 표시

### 5.3 관통 샷

- **다중 타겟 히트**: 한 발로 여러 타겟 타격 가능
- **보너스 계산**: 기본 20점 + (타겟 수-1) * 15점
- **시각적 효과**: 관통 경로 표시, 스크린 플래시
- **보너스 메시지**: 화면 중앙에 관통 보너스 점수 표시

### 5.4 절차적 사운드 시스템

- **동적 사운드 생성**: Web Audio API를 활용한 실시간 사운드 합성
- **사운드 타입**: 총소리 유형별(표준, 강력, 소음기) 다른 특성 부여
- **거리 효과**: 소스로부터의 거리에 따른 볼륨 및 필터 조정
- **환경 특성 반영**: 공간 크기 및 장애물 밀도를 고려한 오디오 처리

### 5.5 공간 오디오 시스템

- **방향성 반향**: 플레이어 방향과 벽의 상대적 위치에 따른 스테레오 패닝
- **다중 벽 반향**: 가까운 벽을 기준으로 다중 반향 효과 생성
- **품질 설정**: 저/중/고 품질 옵션에 따른 계산 복잡도 조정
- **3D 공간 처리**: 고품질 설정 시 완전한 3D 공간 오디오 처리
- **성능 최적화**: 공간 분석 결과 캐싱을 통한 계산 최적화

### 5.6 이벤트 기반 시스템

- **모듈 간 느슨한 결합**: EventSystem을 통한 중앙화된 통신
- **타겟 히트 처리**: TargetManager에서 이벤트 발생, Game에서 구독 처리
- **게임 상태 관리**: 게임 상태 변경 시 이벤트를 통해 관련 모듈에 통지
- **UI 상태 동기화**: 이벤트를 통한 설정 버튼 및 UI 요소 상태 관리

### 5.7 시각적 피드백

- **타겟 파괴 효과**: 타입별 다른 파티클 효과
- **점수 표시**: 타겟 위치에 점수 애니메이션
- **히트 마커**: 화면 중앙에 히트 표시
- **총구 화염**: 발사 시 시각적 효과

### 5.8 모바일 지원

- **터치 컨트롤**: 가상 조이스틱과 발사 버튼
- **시점 변경**: 화면 오른쪽 터치로 시점 조정
- **멀티터치 처리**: 동시에 여러 손가락으로 조작 가능
- **UI 최적화**: 모바일 화면에 맞는 UI 배치

### 5.9 다국어 지원

- **지원 언어**: 한국어(ko), 영어(en)
- **자동 감지**: 브라우저 언어 기반 초기 설정
- **설정 저장**: 선택된 언어 로컬 스토리지에 저장

### 5.10 즉시 플레이

- **리소스 최적화**: 데이터 URI 활용, 경량 에셋
- **지연 로딩**: 필수 자원 먼저 로드 후 게임 시작
- **인라인 스크립트**: 초기 UI 빠르게 표시

## 6. 기술 스택

- **3D 렌더링**: Three.js
- **물리 엔진**: Cannon.js
- **프론트엔드**: HTML5, CSS3, JavaScript (ES6+)
- **오디오**: Web Audio API (절차적 사운드 생성)
- **이벤트 통신**: 커스텀 Pub/Sub 패턴 (EventSystem)
- **저장소**: localStorage (설정 저장)
- **통신**: postMessage API (iframe 간 통신)

## 7. 개발 로드맵 및 버전 이력

| 버전 | 주요 기능 |
|------|----------|
| v0.0.1 | 초기 프로젝트 설정 및 기본 구조 |
| v0.0.2 | 총구 화염 표현, 이동 키 설정 기능 |
| v0.0.3 | 리팩터링(코드 파일 분할) |
| v0.0.4 | 전·후진 오류 수정과 카메라 시점 조작 오류 해결 |
| v0.0.5 | 모바일 시점 조작과 기본 스크롤 충돌 해결 |
| v0.0.6 | 다양한 타겟 시스템, 콤보 기능, 향상된 피드백 |
| v0.0.7 | 로딩 화면 금지 규칙에 맞춰 게임 시작 버튼 제거 |
| v0.0.8 | 타겟 파편 파티클 효과 추가 |
| v0.0.9 | GitHub 비밀 타겟 추가 |
| v0.1.0 | 다국어(한/영) 지원, 모바일 UX 개선, 설정 메뉴 통합 |
| v0.1.1 | 관통 샷 기능 추가 (한 발로 여러 타겟 타격) |
| v0.1.2 | 이벤트 시스템 도입 및 타겟 히트 이벤트 구현 |
| v0.1.3 | 모바일 멀티터치 개선 (시점 및 이동 동시 조작) |
| v0.1.4 | 게임 상태 이벤트 기반 설정 버튼 개선 |
| v0.1.5 | 포괄적 프로젝트 문서화 및 아키텍처 명세 |
| v0.1.6 | Web Audio API 기반 절차적 사운드 생성 및 공간 반향 구현 |
| v0.1.7 | 방향성 스테레오 패닝 기반 고급 공간 오디오 시스템 |

## 8. 향후 개발 방향

1. **성능 최적화**: 모바일 기기에서의 렌더링 및 물리 연산 최적화
2. **이벤트 시스템 확장**: 모든 핵심 모듈에 이벤트 기반 통신 적용
3. **오디오 시스템 확장**: 환경 기반 사운드 및 배경 음악 개선
4. **다중 난이도**: 쉬움, 보통, 어려움 난이도 옵션 추가
5. **멀티플레이어**: 실시간 또는 비동기식 멀티플레이어 모드
6. **추가 무기**: 다양한 무기 유형 및 게임플레이 추가
7. **레벨 시스템**: 프로그레션 및 보상 시스템 구현
8. **AI 적**: 움직이는 AI 적 추가
9. **모드 확장**: 시간 제한, 생존, 도전 등 다양한 게임 모드

## 9. 결론

이 FPS 게임 프로젝트는 모듈식 아키텍처와 이벤트 기반 통신을 통해 확장성과 유지보수성을 확보했으며, 즉시 시작, 모바일 지원, 다국어 지원 등 대회 요구사항을 충족하도록 설계되었습니다. 특히 최근 추가된 절차적 사운드 생성 및 공간 오디오 시스템은 게임의 몰입감을 크게 향상시켰습니다. 모듈 간 느슨한 결합을 통해 확장성을 유지하면서도 고품질의 오디오 및 시각적 피드백을 제공하는 균형 잡힌 아키텍처를 구현했습니다.
